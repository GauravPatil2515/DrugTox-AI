{% extends "base.html" %}

{% block title %}Predict Toxicity - DrugTox-AI Enhanced{% endblock %}

{% block content %}
<div class="page-title">
    <h1>Molecular Toxicity Prediction</h1>
    <p>Predict toxicity across {{ endpoints|length }} biological endpoints using advanced machine learning</p>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <div>
        <!-- Single Prediction -->
        <div class="prediction-form">
            <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-flask"></i>
                Single Molecule Prediction
            </h2>
            
            <form id="singlePredictForm">
                <div class="form-group">
                    <label class="form-label" for="compoundName">Compound Name</label>
                    <input type="text" id="compoundName" class="form-input" placeholder="e.g., Aspirin, Caffeine, Ethanol" required>
                    <small style="color: var(--text-secondary); font-size: 0.875rem;">Enter a descriptive name for your compound</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="smilesInput">SMILES String</label>
                    <textarea id="smilesInput" class="form-input form-textarea" placeholder="e.g., CC(=O)OC1=CC=CC=C1C(=O)O" required></textarea>
                    <small style="color: var(--text-secondary); font-size: 0.875rem;">
                        Enter the SMILES notation for your molecule. <a href="#" onclick="showExamples()">View examples</a>
                    </small>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play"></i>
                        Predict Toxicity
                    </button>
                    <button type="button" class="btn btn-outline" onclick="clearForm()">
                        <i class="fas fa-eraser"></i>
                        Clear
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Batch Prediction -->
        <div class="prediction-form" style="margin-top: 2rem;">
            <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-upload"></i>
                Batch Prediction
            </h2>
            
            <div class="file-upload" id="fileUpload">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                <h3>Upload CSV or SMILES file</h3>
                <p>Drag and drop your file here or click to browse</p>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Supported formats: .csv, .smi, .txt (max 100 molecules)
                </p>
                <input type="file" id="fileInput" accept=".csv,.smi,.txt" style="display: none;">
            </div>
            
            <div id="fileInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--background-color); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="fileName"></span>
                    <button class="btn btn-primary" onclick="processBatchFile()">
                        <i class="fas fa-cogs"></i>
                        Process File
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Container -->
        <div id="resultsContainer" style="margin-top: 2rem; display: none;">
            <div class="results-container">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                    <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                        <i class="fas fa-chart-line"></i>
                        Prediction Results
                    </h2>
                </div>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div>
        <div class="prediction-form">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-lightbulb"></i>
                Example Molecules
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div class="example-molecule" onclick="loadExample('Aspirin', 'CC(=O)OC1=CC=CC=C1C(=O)O')">
                    <strong>Aspirin</strong>
                    <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-secondary);">CC(=O)OC1=CC=CC=C1C(=O)O</div>
                </div>
                
                <div class="example-molecule" onclick="loadExample('Caffeine', 'CN1C=NC2=C1C(=O)N(C(=O)N2C)C')">
                    <strong>Caffeine</strong>
                    <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-secondary);">CN1C=NC2=C1C(=O)N(C(=O)N2C)C</div>
                </div>
                
                <div class="example-molecule" onclick="loadExample('Ethanol', 'CCO')">
                    <strong>Ethanol</strong>
                    <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-secondary);">CCO</div>
                </div>
                
                <div class="example-molecule" onclick="loadExample('Paracetamol', 'CC(=O)Nc1ccc(O)cc1')">
                    <strong>Paracetamol</strong>
                    <div style="font-family: monospace; font-size: 0.75rem; color: var(--text-secondary);">CC(=O)Nc1ccc(O)cc1</div>
                </div>
            </div>
        </div>
        
        <div class="prediction-form" style="margin-top: 1.5rem;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-info-circle"></i>
                Toxicity Endpoints
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                {% for endpoint in endpoints %}
                <div style="padding: 0.5rem; background: var(--background-color); border-radius: 6px; font-size: 0.875rem;">
                    <strong>{{ endpoint }}</strong>
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">
                        {% if 'NR-' in endpoint %}
                        Nuclear Receptor pathway
                        {% elif 'SR-' in endpoint %}
                        Stress Response pathway
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="prediction-form" style="margin-top: 1.5rem;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-question-circle"></i>
                How to Use
            </h3>
            
            <div style="font-size: 0.875rem; line-height: 1.6;">
                <p><strong>1. Single Prediction:</strong> Enter compound name and SMILES string</p>
                <p><strong>2. Batch Prediction:</strong> Upload CSV with 'name' and 'smiles' columns</p>
                <p><strong>3. Interpretation:</strong> Probability > 0.5 = Toxic, < 0.5 = Non-toxic</p>
                <p><strong>4. Confidence:</strong> High = Reliable, Low = Needs validation</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.example-molecule {
    padding: 0.75rem;
    background: var(--background-color);
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.example-molecule:hover {
    background: var(--border-color);
}
</style>

<script>
// Load example molecule
function loadExample(name, smiles) {
    document.getElementById('compoundName').value = name;
    document.getElementById('smilesInput').value = smiles;
}

// Clear form
function clearForm() {
    document.getElementById('compoundName').value = '';
    document.getElementById('smilesInput').value = '';
    document.getElementById('resultsContainer').style.display = 'none';
}

// Single prediction
document.getElementById('singlePredictForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const compoundName = document.getElementById('compoundName').value;
    const smiles = document.getElementById('smilesInput').value;
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsContent = document.getElementById('resultsContent');
    
    // Show loading
    resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><div style="margin-left: 1rem;">Analyzing molecule...</div></div>';
    resultsContainer.style.display = 'block';
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: compoundName,
                smiles: smiles
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displaySingleResult(data.result);
        } else {
            resultsContent.innerHTML = `<div class="alert alert-danger" style="margin: 1.5rem;">${data.error}</div>`;
        }
    } catch (error) {
        resultsContent.innerHTML = `<div class="alert alert-danger" style="margin: 1.5rem;">Error: ${error.message}</div>`;
    }
});

// Display single result
function displaySingleResult(result) {
    const resultsContent = document.getElementById('resultsContent');
    
    let html = `
        <div class="result-item">
            <div class="result-header">
                <div class="compound-info">
                    <h3>${result.compound_name}</h3>
                    <div class="compound-smiles">${result.smiles}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Prediction ID: ${result.prediction_id}</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">${new Date(result.timestamp).toLocaleString()}</div>
                </div>
            </div>
            
            <div class="predictions-grid">
    `;
    
    let toxicCount = 0;
    let totalProb = 0;
    
    for (const [endpoint, prediction] of Object.entries(result.predictions)) {
        const toxicClass = prediction.prediction === 'Toxic' ? 'toxic' : 'non-toxic';
        const confidenceClass = prediction.confidence.toLowerCase();
        
        if (prediction.prediction === 'Toxic') toxicCount++;
        totalProb += prediction.probability;
        
        html += `
            <div class="prediction-card">
                <div class="endpoint-name">${endpoint}</div>
                <div class="prediction-result">
                    <span class="prediction-label ${toxicClass}">${prediction.prediction}</span>
                    <span class="confidence-badge confidence-${confidenceClass}">${prediction.confidence}</span>
                </div>
                <div class="probability-bar">
                    <div class="probability-fill" style="width: ${prediction.probability * 100}%"></div>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                    Probability: ${prediction.probability.toFixed(3)}
                </div>
            </div>
        `;
    }
    
    const avgProb = totalProb / Object.keys(result.predictions).length;
    const riskLevel = avgProb > 0.6 ? 'HIGH' : avgProb > 0.4 ? 'MEDIUM' : 'LOW';
    const riskColor = avgProb > 0.6 ? 'var(--danger-color)' : avgProb > 0.4 ? 'var(--warning-color)' : 'var(--success-color)';
    
    html += `
            </div>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--background-color); border-radius: 8px;">
                <h4 style="margin-bottom: 0.5rem;">Summary</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                        <strong>Toxic Endpoints:</strong> ${toxicCount}/${Object.keys(result.predictions).length}
                    </div>
                    <div>
                        <strong>Average Probability:</strong> ${avgProb.toFixed(3)}
                    </div>
                    <div>
                        <strong>Risk Level:</strong> <span style="color: ${riskColor}; font-weight: 600;">${riskLevel}</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 1rem; text-align: center;">
                <button class="btn btn-outline" onclick="exportResult('${result.prediction_id}')">
                    <i class="fas fa-download"></i>
                    Export Result
                </button>
            </div>
        </div>
    `;
    
    resultsContent.innerHTML = html;
}

// File upload handling
const fileUpload = document.getElementById('fileUpload');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');

fileUpload.addEventListener('click', () => fileInput.click());

fileUpload.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUpload.classList.add('dragover');
});

fileUpload.addEventListener('dragleave', () => {
    fileUpload.classList.remove('dragover');
});

fileUpload.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUpload.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        showFileInfo(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        showFileInfo(e.target.files[0]);
    }
});

function showFileInfo(file) {
    document.getElementById('fileName').textContent = file.name;
    fileInfo.style.display = 'block';
}

// Process batch file
async function processBatchFile() {
    const file = fileInput.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsContent = document.getElementById('resultsContent');
    
    resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><div style="margin-left: 1rem;">Processing batch file...</div></div>';
    resultsContainer.style.display = 'block';
    
    try {
        const response = await fetch('/api/batch_predict', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayBatchResults(data.results);
        } else {
            resultsContent.innerHTML = `<div class="alert alert-danger" style="margin: 1.5rem;">${data.error}</div>`;
        }
    } catch (error) {
        resultsContent.innerHTML = `<div class="alert alert-danger" style="margin: 1.5rem;">Error: ${error.message}</div>`;
    }
}

// Display batch results
function displayBatchResults(results) {
    const resultsContent = document.getElementById('resultsContent');
    
    let html = `
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Batch Results (${results.length} compounds)</h3>
                <button class="btn btn-success" onclick="exportBatchResults()">
                    <i class="fas fa-download"></i>
                    Export All
                </button>
            </div>
        </div>
    `;
    
    results.forEach(result => {
        let toxicCount = 0;
        let totalProb = 0;
        
        for (const prediction of Object.values(result.predictions)) {
            if (prediction.prediction === 'Toxic') toxicCount++;
            totalProb += prediction.probability;
        }
        
        const avgProb = totalProb / Object.keys(result.predictions).length;
        const riskLevel = avgProb > 0.6 ? 'HIGH' : avgProb > 0.4 ? 'MEDIUM' : 'LOW';
        const riskColor = avgProb > 0.6 ? 'var(--danger-color)' : avgProb > 0.4 ? 'var(--warning-color)' : 'var(--success-color)';
        
        html += `
            <div class="result-item">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4>${result.compound_name}</h4>
                        <div style="font-family: monospace; font-size: 0.875rem; color: var(--text-secondary);">${result.smiles}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: ${riskColor}; font-weight: 600;">${riskLevel} RISK</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">${toxicCount}/${Object.keys(result.predictions).length} toxic</div>
                    </div>
                </div>
                
                <div class="predictions-grid">
        `;
        
        for (const [endpoint, prediction] of Object.entries(result.predictions)) {
            const toxicClass = prediction.prediction === 'Toxic' ? 'toxic' : 'non-toxic';
            const confidenceClass = prediction.confidence.toLowerCase();
            
            html += `
                <div class="prediction-card">
                    <div class="endpoint-name">${endpoint}</div>
                    <div class="prediction-result">
                        <span class="prediction-label ${toxicClass}">${prediction.prediction}</span>
                        <span class="confidence-badge confidence-${confidenceClass}">${prediction.confidence}</span>
                    </div>
                    <div class="probability-bar">
                        <div class="probability-fill" style="width: ${prediction.probability * 100}%"></div>
                    </div>
                </div>
            `;
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    resultsContent.innerHTML = html;
}

// Export functions
function exportResult(predictionId) {
    window.open('/api/export_results', '_blank');
}

function exportBatchResults() {
    window.open('/api/export_results', '_blank');
}

function showExamples() {
    alert('SMILES Examples:\n\n• Aspirin: CC(=O)OC1=CC=CC=C1C(=O)O\n• Caffeine: CN1C=NC2=C1C(=O)N(C(=O)N2C)C\n• Ethanol: CCO\n• Benzene: c1ccccc1\n• Water: O');
}
</script>
{% endblock %}